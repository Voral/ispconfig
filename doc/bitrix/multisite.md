# Установка в режиме многосайтовости

В данном случае речь идет о настройки [режима многосайтовости](https://dev.1c-bitrix.ru/learning/course/?COURSE_ID=103&TYPE=Y) на разных доменах с общим ядром Bitrix. Если ранее пользовались BitrixWM, в терминах [документации к виртуальной машине](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=37&LESSON_ID=8849) основной сайт это была установка `kernel` остальные сайты `link`.
 
> Все действия в консоли необходимо выполнять от root. Воспользовавшись классической авторизацией либо `su -` либо `sudo -i` 

1. Настраиваем основной сайт согласно [инструкции](/doc/bitrix/multisite.md)
2. В ISPConfig создаем второй сайт. На вкладке Options:
   * параметру "PHP open_basedir" задаем значение `none`
   * в параметр "Custom php.ini settings" копируем значение из секции php файла [Bitrix](/Bitrix) 
   * в параметр "nginx Directives" копируем значение из секции nginx файла [Bitrix](/Bitrix) 
3. Настраиваем права пользователей. Для этого необходимо установить пользователя первого и второго сайтов. Это можно увидеть в ISPConfig на страницах соответствующих сайтов на вкладке Domain параметр Document Root. Последний каталог в пути равен логину пользователя. Далее необходимо для второго пользователя изменить UID. (в примерах ниже первый пользователь web1 и второй - web2). В файле /etc/passwd устанавливаем UID первого пользователя и редактируем файл записывая аналогичный второму. Например, было:
    ```
   web1:x:5004:5005:....
   web2:x:5005:5005:....
   ```
   Меняем `web2:x:5005:5005:....` -> `web2:x:5004:5005:....` Либо тоже можно выполнить командой:
   ```bash
   usermod web2 -o -u 5004
    ```
4. Переходим в домашний каталог второго пользователя и меняем владельца
    ```bash
    cd /var/www/clients/client0/web2
    find . -user 5005 -exec chown 5004:5005 {} +
    ```

5. Логинимся пользователем и создаем необходимые симлинки для каталогов bitrix, upload, а так же local (если нет специфичной для проекта необходимости разделить последний). Обратите внимание если вы создавали в ISPConfig клиентов и/или еще сайта пути могут отличаться от примера.
   ```bash
   su - web1 -s /bin/bash
   cd /var/www/clients/client0/web2/web
   ln -s /var/www/clients/client0/web2/web/upload .
   ln -s /var/www/clients/client0/web2/web/bitrix .
   ln -s /var/www/clients/client0/web2/web/local .
   ```
   ln -s /var/www/clients/client0/web2/web/upload .
   ln -s /var/www/clients/client0/web2/web/bitrix .
   ln -s /var/www/clients/client0/web2/web/local .

/var/www/clients/client0/web2/web

6. Копируем файлы данного сайта, которые при восстановлении из резервной копии были помещены в соответствующий подкаталог каталога bitrix/backup/sites/
7. В панели управления битрикс для каждого сайта устанавливаем правильное значение параметра "Путь к корневой папке веб-сервера для этого сайта"
8. Для корректной работы обоих сайтов хранение сессий рекомендуется сделать в БД согласно [Документации](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=14026), т.к. у сайтов разные темп директории, соответственно если хранить в файлах то надо приводить всё в одну, чтобы не кастомизировать проще перейти в БД